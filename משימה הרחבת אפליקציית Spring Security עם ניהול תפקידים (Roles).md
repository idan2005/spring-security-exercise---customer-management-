
<div dir="rtl">

# משימה: הרחבת אפליקציית Spring Security עם ניהול תפקידים (Roles)

## רקע כללי
במשימה זו תרחיבו את האפליקציה הקיימת של Spring Security כדי לכלול ניהול תפקידים מתקדם. עד כה עבדתם עם אימות פשוט (Authentication) באמצעות שם משתמש וסיסמה. כעת תוסיפו שכבת הרשאות (Authorization) מבוססת תפקידים.

## מטרות המשימה
1. יצירת מודל נתונים לניהול תפקידים
2. הרחבת שירות האימות לכלול תפקידים
3. הגדרת הרשאות גישה ברמת האפליקציה
4. יישום מיפויים מתאימים לתפקידים שונים

## חלק א': תכנון ויצירת מודל הנתונים

### שלב 1: עיצוב טבלת התפקידים
צרו טבלה חדשה בשם `ROLE` עם המאפיינים הבאים:
- מפתח ראשי אוטומטי
- שם התפקיד (למשל: ADMIN, USER)
- תיאור התפקיד (אופציונלי)

### שלב 2: יצירת קשר רבים-לרבים
צרו קשר רבים-לרבים בין משתמשים לתפקידים:
- משתמש יכול להחזיק במספר תפקידים
- תפקיד יכול להיות משוייך למספר משתמשים

**בחירה בין שתי גישות:**

#### אופציה א': יצירה אוטומטית על ידי Spring
- השתמשו באנוטציה `ManyToMany@` עם `JoinTable@`
- Spring ייצור אוטומטי טבלת חיבור עם שמות ברירת מחדל
- פתרון פשוט ומהיר למימוש

#### אופציה ב': יצירת טבלת חיבור ידנית
- צרו טבלה ידנית בשם `USER_ROLES`
- הגדירו בעצמכם את שמות העמודות והאילוצים
- שליטה מלאה על מבנה הטבלה וה-constraints

**המלצה:** התחילו עם אופציה א' לפשטות, ורק אם נדרשת שליטה מיוחדת עברו לאופציה ב'.

### שלב 3: עדכון ישויות JPA
- הרחיבו את ישות ה-User כדי לכלול קשר לתפקידים
- צרו ישות Role חדשה
- הגדירו את הקשרים בין הישויות בצורה נכונה

## חלק ב': הרחבת שירותי האימות

### שלב 4: עדכון UserDetailsService
- הרחיבו את היישום הקיים של UserDetailsService
- ודאו ששליפת המשתמש כוללת גם את התפקידים שלו
- המירו את התפקידים ל-GrantedAuthority עם הקידומת "_ROLE"

### שלב 5: עדכון תהליך יצירת המשתמש הראשוני
- הרחיבו את המחלקה שיוצרת משתמש ראשוני
- הקצו תפקידים ברירת מחדל (למשל: ADMIN למשתמש הראשון)
- ודאו שהתפקידים נשמרים בבסיס הנתונים

## חלק ג': הגדרת הרשאות ברמת האפליקציה

### שלב 6: עדכון SecurityConfig
הרחיבו את ההגדרות הקיימות ב-SecurityConfig והגדירו נתיבים שונים עם הרשאות שונות:
- נתיבי ניהול (למשל `**/admin/`) - רק למשתמשים עם תפקיד ADMIN
- נתיבי משתמש רגיל (למשל `**/user/`) - למשתמשים עם תפקיד USER ומעלה
- נתיבים ציבוריים - לכל המשתמשים

### שלב 7: הגדרת היררכיית תפקידים (אופציונלי)
- שקלו יצירת היררכיה בין התפקידים (ADMIN כולל את הרשאות USER)
- הגדירו RoleHierarchy אם נדרש

## חלק ד': יישום מיפויים ברמת הבקרים

### שלב 8: יצירת מיפויים מותאמי תפקידים
צרו בקר נפרד או הרחיבו את הבקרים הקיימים עם endpoints שונים כאשר כל תפקיד יקבל endpoints ייעודיים לו.

#### מיפויים עבור ADMIN:
- `admin/dashboard/` - דף ניהול ראשי
- `admin/users/` - רשימת כל המשתמשים
- `admin/users/create/` - יצירת משתמש חדש
- `admin/users/{id}/edit/` - עריכת משתמש
- `admin/users/{id}/delete/` - מחיקת משתמש
- `admin/roles/` - ניהול תפקידים
- `admin/reports/` - דוחות מערכת

#### מיפויים עבור USER:
- `user/profile/` - פרופיל אישי
- `user/profile/edit/` - עריכת פרופיל אישי
- `user/dashboard/` - דף בית של המשתמש
- `user/settings/` - הגדרות אישיות
- `user/activity/` - פעילות אישית

#### נתיבים ציבוריים:
- `/` - דף בית
- `login/` - דף התחברות
- `register/` - דף הרשמה (אם קיים)
- `about/` - אודות
- `contact/` - צור קשר

### שלב 9: יצירת תוכן מותאם תפקיד
- כל controller יכיל מיפויים רגילים (GetMapping, PostMapping וכו')
- התוכן שיוחזר יהיה מותאם לתפקיד המשתמש
- השתמשו ב-SecurityContextHolder.getContext().getAuthentication() כדי לקבל מידע על התפקידים הנוכחיים

#### דוגמאות למיפויים:
- מיפוי שמחזיר תפריט ניווט שונה בהתאם לתפקיד
- מיפוי שמציג נתונים שונים בהתאם לרמת ההרשאה
- מיפויים שמבצעים פעולות שונות בהתאם לתפקיד המשתמש

**הערה חשובה:** האבטחה בפועל תתבצע ב-SecurityConfig ולא באמצעות אנוטציות על ה-controllers.

## חלק ה': בדיקות ואימות

### שלב 10: בדיקת הפונקציונליות
- צרו משתמשים עם תפקידים שונים
- בדקו שהגישה מוגבלת כראוי
- ודאו שמשתמשים לא יכולים לגשת לתוכן שלא מיועד להם

### שלב 11: טיפול בשגיאות
- הוסיפו טיפול מתאים במקרים של גישה לא מורשית
- הגדירו דפי שגיאה מותאמים (403 Forbidden)

## דרישות טכניות נוספות

### אבטחה
- ודאו שהסיסמאות ממשיכות להישמר בצורה מוצפנת
- הגנו מפני CSRF attacks

### ביצועים
- שקלו שימוש ב-lazy loading לטעינת תפקידים
- הוסיפו indexes מתאימים לטבלאות החדשות

### קוד נקי
- שמרו על עקרונות SOLID
- הוסיפו תיעוד מתאים לקוד
- השתמשו ב-conventions של Spring Security

## קריטריוני הערכה
1. **תכנון נכון של מודל הנתונים** (25%)
2. **יישום תקין של UserDetailsService מורחב** (25%)
3. **הגדרה נכונה של הרשאות ב-SecurityConfig** (25%)
4. **יצירת מיפויים מתאימים לתפקידים** (15%)
5. **איכות קוד ותיעוד** (10%)

## משלוח המשימה
- קובץ README עם הוראות הרצה
- קוד מקור מלא עם הערות
- סקריפט SQL ליצירת הטבלאות (אופציונלי)
- צילומי מסך המדגימים את הפונקציונליות

## טיפים למימוש
- התחילו עם תכנון הטבלאות לפני הקוד
- בדקו כל שלב לפני המעבר לשלב הבא
- השתמשו בכלי debugging של Spring Security
- קראו את התיעוד הרשמי של Spring Security 6.x

**הצלחה רבה במשימה!**

</div>